<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Lokaler Gemini Chatbot Test</title>
    <style>
      /* Minimale CSS-Stile für eine übersichtliche Darstellung des Chats. */
      #chat-messages { height: 300px; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
      .bot-message { color: blue; } /* Nachrichten vom Bot sind blau. */
      .user-message { color: green; text-align: right; } /* Nachrichten vom Benutzer sind grün und rechtsbündig. */
    </style>
</head>
<body>
    <h1>Shinkoko Lokaler Chatbot Test</h1>
    <div id="chat-messages"></div>
    <input type="text" id="chat-input" placeholder="Frage hier eingeben..." style="width: 80%;">
    <button id="chat-send">Senden</button>

    <script>
        // URL des lokalen Proxy-Servers, der die Anfragen an die Gemini API weiterleitet.
        const PROXY_SERVER_URL = "http://localhost:3000/api/chat";
        // Ein optionales Secret, das zur Authentifizierung an den Proxy gesendet wird (zur Sicherheit).
        const CHATBOT_SECRET = "Ihr_sehr_langer_zufälliger_Geheimcode_den_Sie_in_Vercel_gespeichert_haben"; 

        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSend = document.getElementById('chat-send');

        // Speichert den gesamten Gesprächsverlauf, um ihn bei jeder Anfrage an die API zu senden.
        const chatHistory = [];

        // Fügt eine Nachricht zum Chatfenster hinzu und speichert sie im Verlauf.
        function addMessage(text, senderClass) {
            // 1. Visuelle Anzeige der Nachricht im Chatfenster.
            const msgDiv = document.createElement('div');
            msgDiv.textContent = text;
            msgDiv.className = senderClass; // Wendet die entsprechenden CSS-Klassen an.
            
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Scrollt automatisch nach unten.

            // 2. Logische Bestimmung der Rolle (Benutzer oder Bot) für die API.
            const role = senderClass.includes('user') ? 'user' : 'bot'; 
            
            // 3. Speicherung der Nachricht im Chat-Verlauf für die API.
            // Lade-Nachrichten werden ignoriert.
            if (role === 'user') {
                chatHistory.push({ role: "user", parts: [{ text: text }] });
            } else if (role === 'bot' && !senderClass.includes('loading')) {
                chatHistory.push({ role: "model", parts: [{ text: text }] });
            }
        }

        // Sendet die Nachricht des Benutzers an den Proxy-Server.
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (message === '') return; // Leere Nachrichten ignorieren.

            // Benutzernachricht zum Chat hinzufügen und Eingabefeld leeren.
            addMessage(message, 'message user-message');
            chatInput.value = '';            

            // Eine "tippt..."-Nachricht anzeigen, um dem Benutzer Feedback zu geben.
            addMessage("Shinkoko-Bot tippt...", 'message bot-message loading');

            try {
                // Den gesamten Chat-Verlauf an den Proxy-Server senden.
                const response = await fetch(PROXY_SERVER_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Chatbot-Secret': CHATBOT_SECRET // Sicherheits-Header.
                    },
                    body: JSON.stringify({ 
                        history: chatHistory // Das komplette Verlaufs-Array wird gesendet.
                    })
                });

                const data = await response.json();
                
                // Die "tippt..."-Nachricht entfernen und die Antwort des Bots anzeigen.
                document.querySelector('.loading').remove();
                addMessage(data.answer, 'message bot-message');

            } catch (error) {
                console.error("Fehler beim Senden der Nachricht:", error);
                addMessage("Entschuldigung, der Chatbot ist momentan nicht erreichbar.", 'bot');
            }
        }

        // Event-Listener für den Senden-Button und die Enter-Taste.
        chatSend.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Startnachricht beim Laden der Seite.
        addMessage("Hallo! Starten Sie Ihren lokalen Test.", 'bot');
    </script>
</body>
</html>